<ejs-appbar cssClass="custom-appbar">
  <ng-template #content>
    <div class="appbar-content">
      <div class="appbar-title">
        <h4 class="mb-0">ðŸ‘¤ Profile</h4>
        <small class="text-muted">Manage your account information</small>
      </div>
    </div>
  </ng-template>
</ejs-appbar>

<div class="profile-container">
  <div class="row">
    <!-- Profile Overview Card -->
    <div class="col-lg-4 mb-4">
      <div class="card profile-card">
        <div class="card-body text-center">
          @if (user(); as currentUser) {
            <!-- Avatar -->
            <div class="profile-avatar">
              <div class="avatar-circle">
                {{ getInitials(currentUser) }}
              </div>
            </div>

            <!-- User Info -->
            <h5 class="profile-name mt-3">
              {{ currentUser.firstName }} {{ currentUser.lastName }}
            </h5>
            <p class="profile-email text-muted">{{ currentUser.email }}</p>

            <!-- Stats -->
            @if (userStats(); as stats) {
              <div class="profile-stats">
                <div class="stat-item">
                  <div class="stat-value">{{ stats.householdCount }}</div>
                  <div class="stat-label">Households</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">{{ stats.role }}</div>
                  <div class="stat-label">Role</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">{{ stats.memberSince }}</div>
                  <div class="stat-label">Member Since</div>
                </div>
              </div>
            }

            <!-- Primary Household -->
            @if (userStats(); as stats) {
              <div class="profile-household mt-3">
                <small class="text-muted">Primary Household</small>
                <div class="household-name">{{ stats.primaryHousehold }}</div>
              </div>
            }

            <!-- Action Buttons -->
            <div class="profile-actions mt-4">
              <button 
                class="btn btn-primary btn-sm me-2"
                (click)="startEditing()"
                [disabled]="isEditing()">
                <i class="fa fa-edit me-1"></i>
                Edit Profile
              </button>
              <button 
                class="btn btn-outline-secondary btn-sm"
                (click)="openPasswordDialog()">
                <i class="fa fa-key me-1"></i>
                Change Password
              </button>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Profile Details Card -->
    <div class="col-lg-8 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Profile Information</h5>
          @if (isEditing()) {
            <div class="btn-group">
              <button 
                class="btn btn-success btn-sm"
                (click)="updateProfile()"
                [disabled]="!profileForm.valid || isLoading()">
                <i class="fa fa-save me-1"></i>
                Save Changes
              </button>
              <button 
                class="btn btn-secondary btn-sm"
                (click)="cancelEditing()"
                [disabled]="isLoading()">
                <i class="fa fa-times me-1"></i>
                Cancel
              </button>
            </div>
          }
        </div>
        <div class="card-body">
          <form [formGroup]="profileForm">
            <div class="row">
              <!-- First Name -->
              <div class="col-md-6 mb-3">
                <label for="firstName" class="form-label">
                  <i class="fa fa-user me-2"></i>First Name *
                </label>
                <ejs-textbox
                  id="firstName"
                  formControlName="firstName"
                  placeholder="Enter first name"
                  cssClass="form-control"
                  [readonly]="!isEditing()">
                </ejs-textbox>
                @if (profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched) {
                  <div class="invalid-feedback d-block">
                    First name is required and must be at least 2 characters.
                  </div>
                }
              </div>

              <!-- Last Name -->
              <div class="col-md-6 mb-3">
                <label for="lastName" class="form-label">
                  <i class="fa fa-user me-2"></i>Last Name *
                </label>
                <ejs-textbox
                  id="lastName"
                  formControlName="lastName"
                  placeholder="Enter last name"
                  cssClass="form-control"
                  [readonly]="!isEditing()">
                </ejs-textbox>
                @if (profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched) {
                  <div class="invalid-feedback d-block">
                    Last name is required and must be at least 2 characters.
                  </div>
                }
              </div>

              <!-- Email -->
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">
                  <i class="fa fa-envelope me-2"></i>Email Address *
                </label>
                <ejs-textbox
                  id="email"
                  formControlName="email"
                  placeholder="Enter email address"
                  cssClass="form-control"
                  [readonly]="!isEditing()">
                </ejs-textbox>
                @if (profileForm.get('email')?.invalid && profileForm.get('email')?.touched) {
                  <div class="invalid-feedback d-block">
                    Please enter a valid email address.
                  </div>
                }
              </div>

              <!-- User ID (Read-only) -->
              <div class="col-md-6 mb-3">
                <label for="userId" class="form-label">
                  <i class="fa fa-id-card me-2"></i>User ID
                </label>
                <ejs-textbox
                  id="userId"
                  [value]="user()?.userId || ''"
                  placeholder="User ID"
                  cssClass="form-control"
                  [readonly]="true">
                </ejs-textbox>
                <small class="text-muted">This is your unique user identifier and cannot be changed.</small>
              </div>
            </div>
          </form>

          <!-- Household Memberships -->
          @if (user()?.households && user()!.households.length > 0) {
            <div class="mt-4">
              <h6 class="mb-3">
                <i class="fa fa-home me-2"></i>Household Memberships
              </h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Household Name</th>
                      <th>Role</th>
                      <th>Joined</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (household of user()!.households; track household.householdId) {
                      <tr>
                        <td>{{ household.householdName }}</td>
                        <td>
                          <span class="badge bg-primary">{{ household.role }}</span>
                        </td>
                        <td>{{ formatDate(household.joinedAt) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }

          <!-- Account Actions -->
          <div class="mt-4 pt-3 border-top">
            <h6 class="mb-3">
              <i class="fa fa-cog me-2"></i>Account Actions
            </h6>
            <div class="d-flex gap-2 flex-wrap">
              <button 
                class="btn btn-outline-warning btn-sm"
                (click)="openPasswordDialog()">
                <i class="fa fa-key me-1"></i>
                Change Password
              </button>
              <button 
                class="btn btn-outline-danger btn-sm"
                (click)="logout()">
                <i class="fa fa-sign-out-alt me-1"></i>
                Sign Out
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Dialog -->
<ejs-dialog
  #passwordDialog
  header="Change Password"
  width="500px"
  [isModal]="true"
  [visible]="false"
  [animationSettings]="{ effect: 'Zoom' }"
  [buttons]="passwordDialogButtons">
  <ng-template #content>
    <form [formGroup]="passwordForm" class="dialog-form">
      <div class="mb-3">
        <label for="currentPassword" class="form-label">
          <i class="fa fa-lock me-2"></i>Current Password *
        </label>
        <ejs-textbox
          id="currentPassword"
          formControlName="currentPassword"
          placeholder="Enter current password"
          cssClass="form-control"
          type="password">
        </ejs-textbox>
        @if (passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched) {
          <div class="invalid-feedback d-block">
            Current password is required.
          </div>
        }
      </div>

      <div class="mb-3">
        <label for="newPassword" class="form-label">
          <i class="fa fa-key me-2"></i>New Password *
        </label>
        <ejs-textbox
          id="newPassword"
          formControlName="newPassword"
          placeholder="Enter new password"
          cssClass="form-control"
          type="password">
        </ejs-textbox>
        @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
          <div class="invalid-feedback d-block">
            New password must be at least 8 characters long.
          </div>
        }
      </div>

      <div class="mb-3">
        <label for="confirmPassword" class="form-label">
          <i class="fa fa-check me-2"></i>Confirm New Password *
        </label>
        <ejs-textbox
          id="confirmPassword"
          formControlName="confirmPassword"
          placeholder="Confirm new password"
          cssClass="form-control"
          type="password">
        </ejs-textbox>
        @if (passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched) {
          <div class="invalid-feedback d-block">
            {{ getPasswordError() || 'Please confirm your new password.' }}
          </div>
        }
      </div>

      <div class="alert alert-info">
        <i class="fa fa-info-circle me-2"></i>
        <strong>Password Requirements:</strong>
        <ul class="mb-0 mt-2">
          <li>At least 8 characters long</li>
          <li>Must match confirmation</li>
        </ul>
      </div>
    </form>
  </ng-template>
</ejs-dialog>
