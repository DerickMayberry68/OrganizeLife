<div class="financial">
  <!-- AppBar Header -->
  <ejs-appbar cssClass="custom-appbar">
    <span class="appbar-title">ðŸ’° Financial Management</span>
    <div class="e-appbar-spacer"></div>
    <button ejs-button cssClass="e-inherit" (click)="openTransactionDialog()">
      + Add Transaction
    </button>
    <button ejs-button cssClass="e-inherit" (click)="openBudgetDialog()">
      + Add Budget
    </button>
  </ejs-appbar>

  <!-- Loading Indicator -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading financial data...</p>
    </div>
  }

  <!-- Financial Overview -->
    <section class="financial__overview">
      <app-stat-card
        title="Total Budget"
        [value]="formatCurrencyValue(totalBudget())"
        icon="ðŸ’µ"
        variant="accent"
      />
      
      <app-stat-card
        title="Total Spent"
        [value]="formatCurrencyValue(totalSpent())"
        icon="ðŸ’³"
        variant="warning"
      />
      
      <app-stat-card
        title="Remaining"
        [value]="formatCurrencyValue(budgetRemaining())"
        icon="ðŸ’°"
        [variant]="budgetRemaining() < 0 ? 'error' : 'success'"
      />
    </section>

    <!-- Budget Chart -->
    <section class="financial__section">
      <div class="card">
        <div class="card-header">
          <h3>Budget Analysis</h3>
        </div>
        <div class="card-content">
          @if (!isLoading() && budgetChartData().length > 0 && budgets().length > 0) {
            <ejs-chart
              style="display:block; width:100%;"
              [primaryXAxis]="primaryXAxis"
              [primaryYAxis]="primaryYAxis"
              [title]="chartTitle"
              [tooltip]="tooltip"
              [background]="chartBackground"
              [palettes]="palettes"
              [height]="'350'"
              [enableAnimation]="true">
              <e-series-collection>
                <e-series 
                  [dataSource]="budgetChartData()" 
                  type='Column' 
                  xName='x' 
                  yName='y' 
                  name='Spent'
                  [marker]="marker">
                </e-series>
                <e-series 
                  [dataSource]="budgetChartData()" 
                  type='Column' 
                  xName='x' 
                  yName='limit' 
                  name='Budget Limit'
                  [marker]="marker">
                </e-series>
              </e-series-collection>
            </ejs-chart>
          } @else if (isLoading()) {
            <div class="empty-state">
              <div class="spinner"></div>
              <p>Loading budget data...</p>
            </div>
          } @else {
            <div class="empty-state">
              <p>ðŸ“Š No budget data available.</p>
              <p>Create a budget to see your spending analysis.</p>
              <button class="btn btn--outline" (click)="openBudgetDialog()">+ Create Budget</button>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Budget Categories -->
    <section class="financial__section">
      <h2>Budget by Category</h2>
      @if (budgets().length > 0) {
        <div class="budget-grid">
          @for (budget of budgets(); track budget.id) {
            <div class="card budget-card">
              <div class="budget-card__header">
                <h3>{{ budget.name }}</h3>
                <span class="budget-card__period">{{ budget.period }}</span>
              </div>
              <div class="budget-card__content">
                <div class="budget-card__progress">
                  <div class="progress-bar">
                    <div 
                      class="progress-bar__fill" 
                      [class]="'progress-bar__fill--' + getBudgetStatus(getBudgetPercentage(budget))"
                      [style.width.%]="getBudgetPercentage(budget)">
                    </div>
                  </div>
                  <div class="progress-bar__labels">
                    <span>{{ formatCurrencyValue(getBudgetSpent(budget)) }}</span>
                    <span>{{ formatCurrencyValue(budget.limitAmount) }}</span>
                  </div>
                </div>
                
                <div class="budget-card__footer">
                  <span class="budget-card__percentage">
                    {{ getBudgetPercentage(budget).toFixed(0) }}% used
                  </span>
                  <span 
                    class="badge" 
                    [class]="'badge--' + getBudgetStatus(getBudgetPercentage(budget))">
                    {{ getBudgetStatus(getBudgetPercentage(budget)) }}
                  </span>
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="card">
          <div class="card-content">
            <div class="empty-state">
              <p>No budgets created yet.</p>
            </div>
          </div>
        </div>
      }
    </section>

    <!-- Recent Transactions -->
    <section class="financial__section">
      <div class="card">
        <div class="card-header">
          <h3>Recent Transactions</h3>
        </div>
        <div class="card-content">
          @if (transactions().length > 0) {
            <ejs-grid 
              [dataSource]="transactions()" 
              [allowPaging]="true"
              [allowSorting]="true"
              [allowFiltering]="true"
              [pageSettings]="pageSettings"
              [filterSettings]="filterSettings">
              <e-columns>
                <e-column field="date" headerText="Date" width="120" [format]="formatDate"></e-column>
                <e-column field="description" headerText="Description" width="200"></e-column>
                <e-column field="accountName" headerText="Account" width="120"></e-column>
                <e-column field="categoryName" headerText="Category" width="120"></e-column>
                <e-column field="type" headerText="Type" width="100"></e-column>
                <e-column field="amount" headerText="Amount" width="120" textAlign="Right" [format]="formatAmount"></e-column>
              </e-columns>
            </ejs-grid>
          } @else {
            <div class="empty-state">
              <p>No transactions recorded yet</p>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Add Transaction Dialog -->
    <ejs-dialog
      #transactionDialog
      header="Add Transaction"
      [width]="dialogWidth"
      [isModal]="true"
      [visible]="false"
      [animationSettings]="animationSettings"
      [buttons]="transactionDialogButtons">
      <ng-template #content>
        <form [formGroup]="transactionForm" class="dialog-form">
          <!-- First Row: Account & Description -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="accountId" class="form-label">Account *</label>
              <select 
                id="accountId"
                formControlName="accountId" 
                class="form-control">
                <option value="">Select an account</option>
                @for (account of accounts(); track account.id) {
                  <option [value]="account.id">{{ account.name }}</option>
                }
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="description" class="form-label">Description *</label>
              <input 
                type="text"
                id="description"
                formControlName="description"
                class="form-control"
                placeholder="Enter description">
            </div>
          </div>

          <!-- Second Row: Amount & Type -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="amount" class="form-label">Amount *</label>
              <input 
                type="number"
                id="amount"
                formControlName="amount"
                class="form-control"
                step="0.01"
                min="0"
                placeholder="0.00">
            </div>

            <div class="col-md-6 mb-3">
              <label for="type" class="form-label">Type *</label>
              <select 
                id="type"
                formControlName="type" 
                class="form-control">
                @for (type of transactionTypes; track type) {
                  <option [value]="type">{{ type }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Third Row: Category & Date -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="categoryId" class="form-label">Category</label>
              <select 
                id="categoryId"
                formControlName="categoryId" 
                class="form-control">
                <option value="">Select a category</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="date" class="form-label">Date *</label>
              <input 
                type="date"
                id="date"
                formControlName="date"
                class="form-control">
            </div>
          </div>

          <!-- Fourth Row: Merchant Name & Notes -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="merchantName" class="form-label">Merchant Name</label>
              <input 
                type="text"
                id="merchantName"
                formControlName="merchantName"
                class="form-control"
                placeholder="Enter merchant name">
            </div>

            <div class="col-md-6 mb-3">
              <label for="notes" class="form-label">Notes</label>
              <textarea 
                id="notes"
                formControlName="notes"
                class="form-control"
                rows="2"
                placeholder="Additional notes...">
              </textarea>
            </div>
          </div>

          <!-- Checkbox (Full Width) -->
          <div class="row">
            <div class="col-12">
              <div class="form-check">
                <input 
                  type="checkbox"
                  id="isRecurring"
                  formControlName="isRecurring"
                  class="form-check-input">
                <label class="form-check-label" for="isRecurring">
                  Recurring Transaction
                </label>
              </div>
            </div>
          </div>
        </form>
      </ng-template>
    </ejs-dialog>

    <!-- Add Budget Dialog -->
    <ejs-dialog
      #budgetDialog
      header="Add Budget Category"
      [width]="dialogWidth"
      [isModal]="true"
      [visible]="false"
      [animationSettings]="animationSettings"
      [buttons]="budgetDialogButtons">
      <ng-template #content>
        <form [formGroup]="budgetForm" class="dialog-form">
          <!-- First Row: Budget Name & Category -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="budgetName" class="form-label">Budget Name *</label>
              <input 
                type="text"
                id="budgetName"
                formControlName="name"
                class="form-control"
                placeholder="Enter budget name">
            </div>

            <div class="col-md-6 mb-3">
              <label for="budgetCategoryId" class="form-label">Category *</label>
              <select 
                id="budgetCategoryId"
                formControlName="categoryId" 
                class="form-control">
                <option value="">Select a category</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Second Row: Budget Limit & Period -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="limitAmount" class="form-label">Budget Limit *</label>
              <input 
                type="number"
                id="limitAmount"
                formControlName="limitAmount"
                class="form-control"
                step="10"
                min="0"
                placeholder="0.00">
            </div>

            <div class="col-md-6 mb-3">
              <label for="period" class="form-label">Period *</label>
              <select 
                id="period"
                formControlName="period" 
                class="form-control">
                @for (period of budgetPeriods; track period) {
                  <option [value]="period">{{ period }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Third Row: Start Date & End Date -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="startDate" class="form-label">Start Date *</label>
              <input 
                type="date"
                id="startDate"
                formControlName="startDate"
                class="form-control">
            </div>

            <div class="col-md-6 mb-3">
              <label for="endDate" class="form-label">End Date</label>
              <input 
                type="date"
                id="endDate"
                formControlName="endDate"
                class="form-control">
            </div>
          </div>

          <!-- Checkbox (Full Width) -->
          <div class="row">
            <div class="col-12">
              <div class="form-check">
                <input 
                  type="checkbox"
                  id="isActive"
                  formControlName="isActive"
                  class="form-check-input">
                <label class="form-check-label" for="isActive">
                  Active Budget
                </label>
              </div>
            </div>
          </div>
        </form>
      </ng-template>
    </ejs-dialog>
</div>
