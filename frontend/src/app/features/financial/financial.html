<div class="financial">
  <h1 class="page-header">
    ðŸ’° Financial Management
    <div class="page-header__actions">
      <button class="btn btn--accent" (click)="openTransactionDialog()">
        + Add Transaction
      </button>
      <button class="btn btn--outline" (click)="openBudgetDialog()">
        + Add Budget
      </button>
    </div>
  </h1>

  <!-- Loading Indicator -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading financial data...</p>
    </div>
  }

  <!-- Financial Overview -->
    <section class="financial__overview">
      <app-stat-card
        title="Total Budget"
        [value]="formatCurrencyValue(totalBudget())"
        icon="ðŸ’µ"
        variant="accent"
      />
      
      <app-stat-card
        title="Total Spent"
        [value]="formatCurrencyValue(totalSpent())"
        icon="ðŸ’³"
        variant="warning"
      />
      
      <app-stat-card
        title="Remaining"
        [value]="formatCurrencyValue(budgetRemaining())"
        icon="ðŸ’°"
        [variant]="budgetRemaining() < 0 ? 'error' : 'success'"
      />
    </section>

    <!-- Budget Chart -->
    <section class="financial__section">
      <div class="card">
        <div class="card-header">
          <h3>Budget Analysis</h3>
        </div>
        <div class="card-content">
          @if (!isLoading() && budgetChartData().length > 0 && budgets().length > 0) {
            <ejs-chart
              style="display:block; width:100%;"
              [primaryXAxis]="primaryXAxis"
              [primaryYAxis]="primaryYAxis"
              [title]="chartTitle"
              [tooltip]="tooltip"
              [background]="chartBackground"
              [palettes]="palettes"
              [height]="'350'"
              [enableAnimation]="true">
              <e-series-collection>
                <e-series 
                  [dataSource]="budgetChartData()" 
                  type='Column' 
                  xName='x' 
                  yName='y' 
                  name='Spent'
                  [marker]="marker">
                </e-series>
                <e-series 
                  [dataSource]="budgetChartData()" 
                  type='Column' 
                  xName='x' 
                  yName='limit' 
                  name='Budget Limit'
                  [marker]="marker">
                </e-series>
              </e-series-collection>
            </ejs-chart>
          } @else if (isLoading()) {
            <div class="empty-state">
              <div class="spinner"></div>
              <p>Loading budget data...</p>
            </div>
          } @else {
            <div class="empty-state">
              <p>ðŸ“Š No budget data available.</p>
              <p>Create a budget to see your spending analysis.</p>
              <button class="btn btn--outline" (click)="openBudgetDialog()">+ Create Budget</button>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Budget Categories -->
    <section class="financial__section">
      <h2>Budget by Category</h2>
      @if (budgets().length > 0) {
        <div class="budget-grid">
          @for (budget of budgets(); track budget.id) {
            <div class="card budget-card">
              <div class="budget-card__header">
                <h3>{{ budget.name }}</h3>
                <span class="budget-card__period">{{ budget.period }}</span>
              </div>
              <div class="budget-card__content">
                <div class="budget-card__progress">
                  <div class="progress-bar">
                    <div 
                      class="progress-bar__fill" 
                      [class]="'progress-bar__fill--' + getBudgetStatus(getBudgetPercentage(budget))"
                      [style.width.%]="getBudgetPercentage(budget)">
                    </div>
                  </div>
                  <div class="progress-bar__labels">
                    <span>{{ formatCurrencyValue(getBudgetSpent(budget)) }}</span>
                    <span>{{ formatCurrencyValue(budget.limitAmount) }}</span>
                  </div>
                </div>
                
                <div class="budget-card__footer">
                  <span class="budget-card__percentage">
                    {{ getBudgetPercentage(budget).toFixed(0) }}% used
                  </span>
                  <span 
                    class="badge" 
                    [class]="'badge--' + getBudgetStatus(getBudgetPercentage(budget))">
                    {{ getBudgetStatus(getBudgetPercentage(budget)) }}
                  </span>
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="card">
          <div class="card-content">
            <div class="empty-state">
              <p>No budgets created yet.</p>
            </div>
          </div>
        </div>
      }
    </section>

    <!-- Recent Transactions -->
    <section class="financial__section">
      <div class="card">
        <div class="card-header">
          <h3>Recent Transactions</h3>
        </div>
        <div class="card-content">
          @if (transactions().length > 0) {
            <ejs-grid 
              [dataSource]="transactions()" 
              [allowPaging]="true"
              [allowSorting]="true"
              [allowFiltering]="true"
              [pageSettings]="pageSettings"
              [filterSettings]="filterSettings">
              <e-columns>
                <e-column field="date" headerText="Date" width="120" [format]="formatDate"></e-column>
                <e-column field="description" headerText="Description" width="200"></e-column>
                <e-column field="accountName" headerText="Account" width="120"></e-column>
                <e-column field="categoryName" headerText="Category" width="120"></e-column>
                <e-column field="type" headerText="Type" width="100"></e-column>
                <e-column field="amount" headerText="Amount" width="120" textAlign="Right" [format]="formatAmount"></e-column>
              </e-columns>
            </ejs-grid>
          } @else {
            <div class="empty-state">
              <p>No transactions recorded yet</p>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Add Transaction Dialog -->
    <ejs-dialog
      #transactionDialog
      header="Add Transaction"
      [width]="dialogWidth"
      [isModal]="true"
      [visible]="false"
      [animationSettings]="animationSettings"
      [buttons]="transactionDialogButtons">
      <ng-template #content>
        <form [formGroup]="transactionForm" class="form">
          <div class="form-group">
            <label>Account *</label>
            <ejs-dropdownlist
              formControlName="accountId"
              [dataSource]="accounts()"
              [fields]="{ text: 'name', value: 'id' }"
              placeholder="Select account">
            </ejs-dropdownlist>
          </div>

          <div class="form-group">
            <label>Description *</label>
            <ejs-textbox formControlName="description" placeholder="Enter description"></ejs-textbox>
          </div>

          <div class="form-group">
            <label>Amount *</label>
            <ejs-numerictextbox
              formControlName="amount"
              [min]="0"
              [step]="0.01"
              format="c2"
              placeholder="0.00">
            </ejs-numerictextbox>
          </div>

          <div class="form-group">
            <label>Type *</label>
            <ejs-dropdownlist
              formControlName="type"
              [dataSource]="transactionTypes"
              placeholder="Select type">
            </ejs-dropdownlist>
          </div>

          <div class="form-group">
            <label>Category</label>
            <ejs-dropdownlist
              formControlName="categoryId"
              [dataSource]="categories()"
              [fields]="{ text: 'name', value: 'id' }"
              placeholder="Select category (optional)">
            </ejs-dropdownlist>
          </div>

          <div class="form-group">
            <label>Date *</label>
            <ejs-datepicker formControlName="date"></ejs-datepicker>
          </div>

          <div class="form-group">
            <label>Merchant Name</label>
            <ejs-textbox formControlName="merchantName" placeholder="Enter merchant name (optional)"></ejs-textbox>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <ejs-textbox formControlName="notes" placeholder="Enter notes (optional)" multiline="true"></ejs-textbox>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" formControlName="isRecurring" />
              Recurring Transaction
            </label>
          </div>
        </form>
      </ng-template>
    </ejs-dialog>

    <!-- Add Budget Dialog -->
    <ejs-dialog
      #budgetDialog
      header="Add Budget Category"
      [width]="dialogWidth"
      [isModal]="true"
      [visible]="false"
      [animationSettings]="animationSettings"
      [buttons]="budgetDialogButtons">
      <ng-template #content>
        <form [formGroup]="budgetForm" class="form">
          <div class="form-group">
            <label>Budget Name *</label>
            <ejs-textbox formControlName="name" placeholder="Enter budget name"></ejs-textbox>
          </div>

          <div class="form-group">
            <label>Category *</label>
            <ejs-dropdownlist
              formControlName="categoryId"
              [dataSource]="categories()"
              [fields]="{ text: 'name', value: 'id' }"
              placeholder="Select category">
            </ejs-dropdownlist>
          </div>

          <div class="form-group">
            <label>Budget Limit Amount *</label>
            <ejs-numerictextbox
              formControlName="limitAmount"
              [min]="0"
              [step]="10"
              format="c2"
              placeholder="0.00">
            </ejs-numerictextbox>
          </div>

          <div class="form-group">
            <label>Period *</label>
            <ejs-dropdownlist
              formControlName="period"
              [dataSource]="budgetPeriods"
              placeholder="Select period">
            </ejs-dropdownlist>
          </div>

          <div class="form-group">
            <label>Start Date *</label>
            <ejs-datepicker formControlName="startDate"></ejs-datepicker>
          </div>

          <div class="form-group">
            <label>End Date</label>
            <ejs-datepicker formControlName="endDate" placeholder="Optional"></ejs-datepicker>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" formControlName="isActive" />
              Active Budget
            </label>
          </div>
        </form>
      </ng-template>
    </ejs-dialog>
</div>
